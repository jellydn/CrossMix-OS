name: CrossMix-OS Canary Brick Release

permissions:
  id-token: "write"
  contents: "write"
  packages: "write"
  pull-requests: "read"

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  canary-brick-release:
    name: Canary Brick release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, '[skip canary]')"

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Get version and build info
        run: |
          # Get the latest stable version from upstream repo
          LATEST_TAG=$(curl -s https://api.github.com/repos/cizia64/CrossMix-OS/releases/latest | jq -r '.tag_name' || echo "v1.3.0")
          BASE_VERSION=${LATEST_TAG#v}
          
          # Create canary version with short commit hash and timestamp
          SHORT_SHA=$(git rev-parse --short HEAD)
          TIMESTAMP=$(date +%Y%m%d-%H%M)
          CANARY_VERSION="${BASE_VERSION}-canary.${TIMESTAMP}.${SHORT_SHA}"
          
          echo "BASE_VERSION=${BASE_VERSION}" >> $GITHUB_ENV
          echo "CANARY_VERSION=${CANARY_VERSION}" >> $GITHUB_ENV
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "TIMESTAMP=${TIMESTAMP}" >> $GITHUB_ENV
          
          echo "Building Brick canary version: ${CANARY_VERSION}"
      
      - name: Install 7-Zip
        run: |
          mkdir -p /home/runner/work/CrossMix-OS/tools
          wget https://www.7-zip.org/a/7z2406-linux-x64.tar.xz -P /home/runner/work/CrossMix-OS/tools
          tar xvf /home/runner/work/CrossMix-OS/tools/7z2406-linux-x64.tar.xz -C /home/runner/work/CrossMix-OS/tools
          sudo cp /home/runner/work/CrossMix-OS/tools/7zz /usr/local/bin/
      
      - name: Update version file for canary
        run: |
          echo "${CANARY_VERSION}" > /home/runner/work/CrossMix-OS/CrossMix-OS/System/usr/trimui/crossmix-version.txt
          
      - name: Extract RetroArch cores
        run: |
          find /home/runner/work/CrossMix-OS/CrossMix-OS/RetroArch/.retroarch/cores -name "*.7z" -execdir 7zz x {} \; -execdir rm {} \;
      
      - name: Cleaning image and prepare Brick build
        run: |
          find /home/runner/work/CrossMix-OS/CrossMix-OS -type f -name ".gitkeep" -delete
          rm -rf /home/runner/work/CrossMix-OS/CrossMix-OS/_assets
          rm /home/runner/work/CrossMix-OS/CrossMix-OS/LICENSE
          rm /home/runner/work/CrossMix-OS/CrossMix-OS/README.md
          rm -rf /home/runner/work/CrossMix-OS/CrossMix-OS/.git
          rm -rf /home/runner/work/CrossMix-OS/CrossMix-OS/.github
          cd /home/runner/work/CrossMix-OS/CrossMix-OS
          /usr/local/bin/7zz a RetroArch/default_config.7z RetroArch/retroarch.cfg RetroArch/.retroarch/config/*
          
          # Brick-specific preparation: Remove heavy components
          echo "Removing heavy emulators for Brick build..."
          rm -rf Emus/SCUMMVM Emus/PSP Emus/DC Emus/SATURN Emus/NDS
          rm -rf Apps/PortMaster
          
          echo "Removing heavy RetroArch cores..."
          rm -f RetroArch/.retroarch/cores/mame2015_libretro.so
          rm -f RetroArch/.retroarch/cores/scummvm_libretro-2.9.so
          rm -f RetroArch/.retroarch/cores/mame2010_libretro.so
          rm -f RetroArch/.retroarch/cores/fbneo_libretro.so
          rm -f RetroArch/.retroarch/cores/flycast_libretro.so
          rm -f RetroArch/.retroarch/cores/ppsspp_libretro.so
          
          echo "Removing heavy BIOS files..."
          rm -rf BIOS/ScummVM
          
          # Remove TSP boot logo images and keep legacy ones
          rm -rf Apps/BootLogo/Images_1280x720
          
          # Create device identifier file for Brick devices
          mkdir -p etc
          echo "brick" > etc/trimui_device.txt
      
      - name: Create Brick build in parts
        run: |
          shopt -s dotglob
          cd /home/runner/work/CrossMix-OS/CrossMix-OS
          echo "Creating TrimUI Brick (1024x768) build with optimized components in multiple parts..."
          
          # Split build into manageable parts
          echo "Creating Part 1: Core system and basic emulators..."
          zip -r "/home/runner/work/CrossMix-OS/CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part1.zip" \
            System Apps Emus BIOS Themes Icons Backgrounds trimui etc
          
          echo "Creating Part 2: RetroArch and remaining components..."
          zip -r "/home/runner/work/CrossMix-OS/CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part2.zip" \
            RetroArch Pictures Data autorun.inf .VolumeIcon.icns
          
          # Create installation script
          cat > "/home/runner/work/CrossMix-OS/install_brick.sh" << 'EOF'
          #!/bin/sh
          echo "CrossMix-OS TrimUI Brick Installation Script"
          echo "============================================"
          
          # Check if both parts are present
          if [ ! -f "CrossMix-OS_v*_Brick_Part1.zip" ] || [ ! -f "CrossMix-OS_v*_Brick_Part2.zip" ]; then
            echo "Error: Both part files must be present in the same directory"
            echo "Required files:"
            echo "- CrossMix-OS_v*_Brick_Part1.zip"
            echo "- CrossMix-OS_v*_Brick_Part2.zip"
            exit 1
          fi
          
          echo "Extracting Part 1 (Core system)..."
          unzip -q CrossMix-OS_v*_Brick_Part1.zip
          
          echo "Extracting Part 2 (RetroArch and components)..."
          unzip -q CrossMix-OS_v*_Brick_Part2.zip
          
          echo "Installation complete!"
          echo "You can now copy the extracted files to your TrimUI Brick SD card."
          echo "Remember to backup your existing installation first!"
          EOF
          
          echo "Build size information:"
          ls -lh /home/runner/work/CrossMix-OS/CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part*.zip
      
      - name: Delete previous Brick canary releases
        run: |
          # Delete previous Brick canary releases to avoid cluttering (keep latest 5)
          gh release list --limit 50 --repo ${{ github.repository }} | grep -E "v.*-canary\.*Brick" | tail -n +6 | while read -r line; do
            tag=$(echo "$line" | awk '{print $1}')
            echo "Deleting old Brick canary release: $tag"
            gh release delete "$tag" --yes --repo ${{ github.repository }} || true
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Brick Canary Release
        run: |
          # Create release using GitHub CLI with multi-part files
          gh release create "v${{ env.CANARY_VERSION }}-Brick" \
            --repo ${{ github.repository }} \
            --title "CrossMix-OS v${{ env.CANARY_VERSION }} Brick (Canary)" \
            --notes "## 🚧 Brick Canary Release - v${{ env.CANARY_VERSION }}

          **⚠️ This is an automated pre-release build for TrimUI Brick devices only.**

          - **Commit:** ${{ github.sha }}
          - **Branch:** ${{ github.ref_name }}
          - **Build Date:** ${{ env.TIMESTAMP }}
          - **Base Version:** ${{ env.BASE_VERSION }}
          - **Device:** TrimUI Brick (1024x768)

          ### 📦 Brick Build Features
          - Optimized build for lower-spec device
          - Essential emulators only (no PSP, DC, Saturn, NDS, SCUMMVM)
          - Lightweight RetroArch cores
          - Optimized assets for smaller screen
          - No PortMaster (requires more processing power)

          ### 💾 Installation Instructions
          This build is split into multiple parts to avoid GitHub's 2GB file size limit:

          1. **Download both parts:**
             - \`CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part1.zip\` (Core system)
             - \`CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part2.zip\` (RetroArch)
             - \`install_brick.sh\` (Installation script)

          2. **Install:**
             - Place all files in the same directory
             - Run: \`bash install_brick.sh\`
             - Copy extracted files to your TrimUI Brick SD card

          ### 📋 Recent Changes
          ${{ github.event.head_commit.message }}

          ### ⚠️ Important Notes
          - This build is **only for TrimUI Brick devices**
          - **Download ALL parts** for complete installation
          - This is a **development build** and may contain bugs
          - Use at your own risk - always backup your device first
          - Report issues on the [GitHub Issues](https://github.com/cizia64/CrossMix-OS/issues) page

          ### 🔄 OTA Update Support
          OTA updates will be updated to handle multi-part downloads in a future release." \
            --prerelease \
            "/home/runner/work/CrossMix-OS/CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part1.zip" \
            "/home/runner/work/CrossMix-OS/CrossMix-OS_v${{ env.CANARY_VERSION }}_Brick_Part2.zip" \
            "/home/runner/work/CrossMix-OS/install_brick.sh"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}